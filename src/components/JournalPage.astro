---
import Layout from '../layouts/Layout.astro';
import { SUPPORTED_LOCALES, translations, defaultLocale, type Locale } from '../i18n/translations';
import { summarizeFromMarkdown } from '../utils/summarize';

const { locale } = Astro.props as { locale: Locale };
const t = translations[locale];

const journalPath = locale === defaultLocale ? '/journals/' : `/${locale}/journals/`;

const languageLinks = SUPPORTED_LOCALES.map((code) => ({
  lang: code,
  label: t.layout.languageNames[code],
  href: code === defaultLocale ? '/journals/' : `/${code}/journals/`,
  active: code === locale,
}));

const navLinks = [
  { label: t.layout.learningJourneyLabel, href: journalPath, active: true },
  { label: t.layout.knowledgeBaseLabel, href: locale === defaultLocale ? '/knowledge-base/' : `/${locale}/knowledge-base/`, active: false },
  { label: t.layout.webtoolsLabel, href: locale === defaultLocale ? '/webtools/' : `/${locale}/webtools/`, active: false },
];

// ------------------------------
// üîß 1Ô∏è‚É£ Load semua post MDX
// ------------------------------
const modules = import.meta.glob('/src/contents/journals/*.{md,mdx}', { eager: true });
let posts = Object.entries(modules).map(([file, mod]) => {
  const m = mod as any;
  return {
    file,
    frontmatter: m.frontmatter ?? {},
    Content: m.default ?? null,
    raw: (m as any).raw ?? (m as any).rawContent ?? '',
  };
});

// ------------------------------
// üîß 2Ô∏è‚É£ Load semua gambar dari src/assets/images/
// ------------------------------
const imageModules = import.meta.glob('/src/assets/images/journals/*.{avif,png,jpg,jpeg,webp}', { eager: true });
const imageMap: Record<string, string> = Object.entries(imageModules).reduce((acc, [path, mod]) => {
  const filename = path.split('/').pop();
  const src = (mod as any).default?.src ?? (mod as any).src ?? (mod as any).default ?? '';
  if (filename && src) acc[filename] = src;
  return acc;
}, {});

// ------------------------------
// üîß 3Ô∏è‚É£ Buat post list dengan thumbnail otomatis
// ------------------------------
const BASE_POST_PATH = '/journals';

posts = posts.map((p) => {
  const slug = p.file.split('/').pop().replace(/\.mdx?$/, '');
  const fm = p.frontmatter ?? {};
  const raw = p.raw ?? '';

  const excerpt = fm.excerpt ?? summarizeFromMarkdown(raw, 160);

  // ‚úÖ ambil thumb berdasarkan coverFileName
  let thumbSrc = '';
  const coverFileName = fm.coverFileName;
  if (coverFileName && imageMap[coverFileName]) {
    thumbSrc = imageMap[coverFileName];
  }

  return {
    slug,
    href: `${BASE_POST_PATH}/${slug}`,
    title: fm.title ?? 'Untitled',
    date: fm.date ?? null,
    status: fm.status ?? 'published',
    excerpt,
    thumbSrc,
  };
});

// hide drafts on production
if (import.meta.env.PROD) posts = posts.filter((p) => p.status !== 'draft');

// sort newest first
posts.sort((a, b) => new Date(b.date || 0).getTime() - new Date(a.date || 0).getTime());
---

<Layout
	title={t.learningJourney.meta.title}
	description={t.learningJourney.meta.description}
	brand={t.layout.brand}
	locale={locale}
	languageLinks={languageLinks}
	navLinks={navLinks}
	navLabel={t.layout.primaryNavLabel}
	mobileMenuLabel={t.layout.mobileMenuLabel}
	switcherLabel={t.layout.languageSwitcherLabel}
	themeToggleLabel={t.layout.themeToggleLabel}
>
	<section class="journey-timeline" aria-label={t.learningJourney.timelineLabel}>
	<div class="journey-timeline__header">
	  <h2>
		<i class="ri-road-map-line" aria-hidden="true"></i>
		{t.learningJourney.timelineLabel}
	  </h2>
	  <p>{t.learningJourney.meta.description}</p>
	</div>
  
	<div class="journey-grid">
		{posts.map((entry) => {
		  const isoDate = entry.date ? new Date(entry.date).toISOString() : null;
		  const humanDate = entry.date
			? new Date(entry.date).toLocaleDateString('id-ID', {
				day: 'numeric',
				month: 'long',
				year: 'numeric'
				})
			: 'no-date';
		  const summaryId = `summary-${entry.slug}`;
	  
		  return (
			<article class="journey-card" key={entry.slug}>
			  <a
				class="journey-card__link"
				href={entry.href}
				aria-label={`Baca: ${entry.title}`}
				aria-describedby={entry.excerpt ? summaryId : undefined}
			  >
				{entry.thumbSrc ? (
				  <div class="journey-card__media">
					<img
					  class="journey-card__thumb"
					  src={entry.thumbSrc}
					  alt={`Thumbnail ‚Äî ${entry.title}`}
					  loading="lazy"
					  decoding="async"
					  width="320"
					  height="180"
					/>
				  </div>
				) : (
				  <div class="journey-card__media journey-card__media--placeholder" aria-hidden="true" />
				)}
	  
				<div class="journey-card__body">
				  <span class="journey-card__year">
					{entry.date ? <time datetime={isoDate}>{humanDate}</time> : 'no-date'}
				  </span>
				  <h3>{entry.title}</h3>
				  {entry.excerpt ? (
					<p id={summaryId} class="journey-card__summary">{entry.excerpt}</p>
				  ) : null}
				</div>
			  </a>
			</article>
		  );
		})}
	  </div>
	  
  	</section>
  
</Layout>

<style>
	.journey-hero {
		display: grid;
		gap: 20px;
		padding: 36px;
		border-radius: 28px;
		background:
			linear-gradient(160deg, rgba(210, 210, 207, 0.18), transparent 65%),
			var(--surface-card);
		border: 1px solid var(--glass-stroke);
		box-shadow: var(--shadow-soft);
		backdrop-filter: blur(22px);
	}

	.journey-hero__content {
		display: grid;
		gap: 18px;
	}

	.journey-hero__eyebrow {
		display: inline-flex;
		align-items: center;
		gap: 8px;
		padding: 6px 14px;
		border-radius: 999px;
		border: 1px solid var(--glass-stroke);
		background: var(--surface-highlight);
		color: var(--text-muted);
		font-size: 0.82rem;
		text-transform: uppercase;
		letter-spacing: 0.14em;
	}

	h1 {
		margin: 0;
		font-family: var(--font-display);
		font-size: clamp(2.2rem, 5vw, 3.2rem);
	}

	.journey-hero__intro {
		margin: 0;
		color: var(--text-muted);
		font-size: 1.08rem;
		max-width: 70ch;
	}

	.journey-hero__back {
		display: inline-flex;
		align-items: center;
		justify-content: flex-start;
		gap: 8px;
		padding: 10px 18px;
		border-radius: 999px;
		color: var(--accent);
		font-weight: 600;
		font-size: 0.92rem;
		letter-spacing: 0.04em;
		width: fit-content;
		transition: transform 0.2s ease, color 0.2s ease;
	}

	.journey-hero__back:hover {
		transform: translateX(-4px);
		color: var(--accent-strong);
	}

	.journey-timeline {
		display: grid;
		gap: 24px;
	}

	.journey-timeline__header {
		display: grid;
		gap: 12px;
	}

	.journey-timeline__header h2 {
		display: inline-flex;
		align-items: center;
		gap: 10px;
		margin: 0;
		font-family: var(--font-display);
		font-size: clamp(1.8rem, 3.5vw, 2.4rem);
	}

	.journey-timeline__header p {
		margin: 0;
		color: var(--text-muted);
		max-width: 65ch;
	}

	.journey-grid {
		display: grid;
		gap: 18px;
	}

	/* Card container */
	.journey-card {
	padding: 18px;
	border-radius: 14px;
	background: var(--surface-card);
	border: 1px solid var(--glass-stroke);
	box-shadow: var(--shadow-soft);
	}

	/* Make the whole card clickable and layout as row */
	.journey-card__link {
	display: flex;
	gap: 16px;
	align-items: flex-start;
	text-decoration: none;
	color: inherit;
	}

	/* Media column (left) */
	.journey-card__media {
	flex: 0 0 160px; /* fixed thumbnail column width */
	width: 160px;
	}

	.journey-card__media--placeholder {
	width: 160px;
	height: 120px;
	border-radius: 10px;
	background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
	border: 1px dashed var(--glass-stroke);
	}

	/* thumb image */
	.journey-card__thumb {
	width: 100%;
	height: 100%;
	/* aspect-ratio: 16/9; */
	object-fit: cover;
	border-radius: 10px;
	display: block;
	box-shadow: var(--shadow-soft);
	border: 1px solid var(--glass-stroke);
	}

	/* Body column */
	.journey-card__body {
	flex: 1 1 auto;
	display: flex;
	flex-direction: column;
	gap: 8px;
	}

	/* Year/title/summary */
	.journey-card__year {
	font-weight: 600;
	font-size: 0.9rem;
	color: var(--text-muted);
	text-transform: uppercase;
	letter-spacing: 0.08em;
	}

	.journey-card__summary {
	margin: 0;
	color: var(--text-muted);
	}

	/* Responsive: stack on small screens */
	@media (max-width: 640px) {
	.journey-card__link {
		flex-direction: column;
		gap: 12px;
	}
	.journey-card__media,
	.journey-card__media--placeholder {
		width: 100%;
		height: auto;
	}
	.journey-card__thumb {
		aspect-ratio: auto;
		height: 160px;
		width: 100%;
	}
	}

</style>
